= Quarkus Integration
:toc: left
:toclevels: 3
:source-highlighter: highlight.js
:toc-title: Table of Contents
:sectnums:


== Overview

The oauth-sheriff-quarkus extension integrates the JWT validation library with Quarkus applications, providing automatic configuration, health checks, metrics, and DevUI integration. This document describes the current implementation and architecture of the extension.

== Architecture

The extension follows the standard Quarkus extension architecture with separate deployment and runtime modules:

* **Deployment Module**: Handles build-time processing, registers classes for reflection, and sets up DevUI components
* **Runtime Module**: Provides runtime components, configuration classes, health checks, and metrics integration

=== Key Components

==== OAuthSheriffProcessor

The `OAuthSheriffProcessor` class handles build-time processing for the extension:

* Registers the `oauth-sheriff` feature
* Sets up reflection for configuration classes:
  ** `JwtValidationConfig` and its nested classes
  ** Core JWT validation classes like `TokenValidator`, `IssuerConfig`, etc.

* Registers classes that need runtime initialization:
  ** `HttpJwksLoader` for proper native image support

* Configures DevUI components for development mode

==== OAuthSheriffRecorder

The `OAuthSheriffRecorder` class follows Quarkus best practices by leveraging CDI for component management. All runtime initialization is handled by CDI, and health checks are automatically discovered by Quarkus through their annotations (`@ApplicationScoped`, `@Readiness`, `@Liveness`).

==== Health Checks

Two health checks are provided:

* `JwksEndpointHealthCheck` (`@Readiness`): Monitors connectivity to JWKS endpoints
* `TokenValidatorHealthCheck` (`@Liveness`): Validates TokenValidator configuration

These health checks are automatically discovered by Quarkus through their annotations:

* `@ApplicationScoped`: Defines the bean scope
* `@Readiness` or `@Liveness`: Identifies the health check type
* Implementation of the `HealthCheck` interface

No explicit registration is needed in the `OAuthSheriffProcessor` class, as Quarkus handles the discovery and registration automatically.

See xref:health-checks.adoc[Health Checks] for detailed information.

==== Metrics Integration

The extension automatically exposes metrics when the Quarkus Micrometer extension is present:

* JWT validation error counters
* Security event monitoring
* Performance metrics

See xref:metrics-integration.adoc[Metrics Integration] for detailed information.

== Configuration

The extension uses MicroProfile Config API with the `sheriff.oauth` prefix:

[source,properties]
----
# Basic configuration
sheriff.oauth.enabled=true
sheriff.oauth.parser.allow-unsafe-algorithms=false
sheriff.oauth.parser.max-token-size-bytes=8192

# Issuer configuration
sheriff.oauth.issuers.keycloak.issuer-identifier=https://keycloak.example.com/auth/realms/master
sheriff.oauth.issuers.keycloak.jwks.http.url=https://keycloak.example.com/auth/realms/master/protocol/openid-connect/certs
----

Configuration is resolved through dedicated resolver classes that access properties via MicroProfile Config.

== DevUI Integration

In development mode, the extension provides DevUI integration with:

* JWT Validation Status monitoring
* JWKS Endpoint connectivity status
* Token debugging tools
* Configuration overview

The DevUI integration is implemented through:

* `OAuthSheriffProcessor.createJwtDevUICard()`: Creates the DevUI card pages
* `OAuthSheriffProcessor.createJwtDevUIJsonRPCService()`: Registers the JSON-RPC service
* `OAuthSheriffDevUIJsonRPCService`: Provides runtime data access for the DevUI components

The DevUI components are only active in development mode, controlled by the `@BuildStep(onlyIf = IsDevelopment.class)` annotation.

== Native Image Support

The extension supports GraalVM native image compilation with:

* Reflection configuration for JWT validation classes
* Runtime initialization for network-dependent components
* Proper resource inclusion

See xref:../configuration/native-image-configuration.adoc[Native Image Configuration] for detailed information.

== Best Practices

=== Component Discovery

The extension leverages Quarkus's built-in mechanisms for component discovery:

* Health checks are automatically discovered through annotations
* CDI manages component lifecycle
* Metrics are automatically registered when Micrometer is present

=== Simplicity

The extension follows the principle of simplicity:

* Minimal code in the Recorder class
* Clear separation between build-time and runtime components
* Reliance on Quarkus's built-in mechanisms rather than custom implementations

=== Documentation

Comprehensive documentation is provided for all aspects of the extension:

* Configuration options
* Health check behavior
* Metrics integration
* DevUI components

== Testing

The extension includes comprehensive tests:

* Unit tests for all components
* Integration tests with Quarkus test framework
* Health check validation
* Metrics collection verification

See xref:../development/quarkus-test-setup.adoc[Quarkus Test Setup] for information on testing the extension.

== Maven Configuration

The extension is configured as a standard Quarkus extension with:

* Deployment and runtime modules
* Proper dependency management
* Build plugin configuration

See xref:../configuration/maven-build-configuration.adoc[Maven Build Configuration] for detailed information.
