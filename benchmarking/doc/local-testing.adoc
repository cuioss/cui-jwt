= Local Testing Guide
:toc: left
:toclevels: 3
:toc-title: Table of Contents
:sectnums:
:source-highlighter: highlight.js


== Quick Start

To run benchmarks and view results locally:

=== Step 1: Run Benchmarks

[source,bash]
----
# Run micro benchmarks (completes in ~1 minute with quick profile)
./mvnw verify -pl benchmarking/benchmark-core -Pbenchmark

# Run WRK load testing benchmarks
./mvnw verify -pl benchmarking/benchmark-integration-wrk -Pbenchmark
----

These commands automatically generate:

- Raw JMH benchmark results (JSON)
- HTML reports with interactive visualizations
- Performance badges
- GitHub Pages ready deployment structure

=== Step 2: Serve Results Locally

[source,bash]
----
cd benchmarking/scripts

# Serve library benchmark results
./serve-reports.sh library

# Serve WRK load testing results
./serve-reports.sh wrk

# To stop the server:
./serve-reports.sh stop
----

=== Step 3: View Results

Open your browser to http://localhost:8080 to view:

- Performance overview dashboards
- Interactive charts and trends
- Detailed benchmark tables
- Performance badges and metrics

== Generated Artifacts Location

Each benchmark run generates a complete set of reports in its own `target/benchmark-results/` directory:

=== Module: library

* **Directory**: `benchmarking/benchmark-core/target/benchmark-results/`
* **Generated by**: Running library benchmarks with `-Pbenchmark`
* **Contains**:
  - `gh-pages-ready/` - Complete HTML reports and badges ready for GitHub Pages
  - `gh-pages-ready/index.html` - Main benchmark report
  - `gh-pages-ready/trends.html` - Historical trends
  - `gh-pages-ready/detailed.html` - Detailed benchmark results
  - `gh-pages-ready/badges/` - Performance badges (JSON and SVG)
  - `gh-pages-ready/data/` - Structured benchmark data
  - `micro-result.json` - Raw JMH output
  - `jwt-validation-metrics.json` - Performance metrics

=== Module: wrk

* **Directory**: `benchmarking/benchmark-integration-wrk/target/benchmark-results/`
* **Generated by**: Running WRK benchmarks with `-Pbenchmark`
* **Contains**:
  - `gh-pages-ready/` - Complete HTML reports and badges ready for GitHub Pages
  - `gh-pages-ready/index.html` - Main benchmark report
  - `gh-pages-ready/trends.html` - Historical trends
  - `gh-pages-ready/detailed.html` - Detailed benchmark results
  - `gh-pages-ready/badges/` - Performance badges
  - `wrk/*.txt` - WRK load testing output
  - `prometheus/` - Prometheus metrics
  - Various metrics JSON files

== Manual HTTP Server Options

If you want to bypass the serve-reports.sh script, you can serve reports directly:

[source,bash]
----
# Serve library benchmark reports
cd benchmarking/benchmark-core/target/benchmark-results/gh-pages-ready
python3 -m http.server 8080

# Serve WRK benchmark reports
cd benchmarking/benchmark-integration-wrk/target/benchmark-results/gh-pages-ready
python3 -m http.server 8080
----

Alternative servers:

[source,bash]
----
# Node.js (requires http-server)
npx http-server -p 8080

# PHP
php -S localhost:8080

# Ruby
ruby -run -ehttpd . -p8080
----

== Why HTTP Server?

Modern browsers enforce strict security policies that prevent JavaScript from loading local files directly (CORS policy). An HTTP server provides the proper protocol and headers for the interactive reports to function correctly.

== Report Contents

The `gh-pages-ready/` directory contains a complete, self-contained report structure:

* **HTML Reports**:
  - `index.html` - Overview with latest results
  - `trends.html` - Historical performance trends
  - `detailed.html` - Detailed benchmark analysis

* **Performance Badges** (`badges/` directory):
  - `performance-badge.json` - Current performance score
  - `trend-badge.json` - Performance trend indicator
  - `last-run-badge.json` - Last execution timestamp

* **Structured Data** (`data/` directory):
  - `benchmark-data.json` - Processed benchmark metrics
  - `original-jmh-result.json` - Raw JMH output

* **API Endpoints** (`api/` directory):
  - `benchmarks.json` - All benchmark results
  - `latest.json` - Latest run metadata
  - `status.json` - Quality gate status

* **Historical Data** (`history/` directory):
  - Timestamped JSON files for trend analysis

== Troubleshooting

=== No Results Generated

- Ensure benchmarks ran successfully (check Maven output)
- Check for compilation errors
- Verify the correct Maven profile was used (`-Pbenchmark`)

=== "Failed to fetch" Errors

- Make sure you're accessing via `http://localhost:8080`, not `file://`
- Check that the HTTP server is running
- Verify you're in the correct directory

=== 404 Errors

- Verify benchmark results were generated in `target/benchmark-results/`
- Check that `gh-pages-ready/` directory exists
- Ensure you're serving from the correct directory

=== Port Already in Use

- Try a different port number: `./serve-reports.sh library 8081`
- Check for other running servers: `lsof -i :8080`
- Stop existing servers: `./serve-reports.sh stop`

== Development Tips

=== Quick Workflow Examples

[source,bash]
----
# 1. Quick library benchmark run (reduced iterations for fast feedback)
./mvnw verify -pl benchmarking/benchmark-core -Pbenchmark \
  -Djmh.iterations=1 -Djmh.warmupIterations=1
cd benchmarking/scripts && ./serve-reports.sh library

# 2. Full library benchmark run (production settings)
./mvnw verify -pl benchmarking/benchmark-core -Pbenchmark
cd benchmarking/scripts && ./serve-reports.sh library

# 3. WRK integration benchmarks
./mvnw verify -pl benchmarking/benchmark-integration-wrk -Pbenchmark
cd benchmarking/scripts && ./serve-reports.sh wrk

# 4. Run multiple servers for comparison (different ports)
cd benchmarking/scripts
./serve-reports.sh library 8081 &  # Library results on port 8081
./serve-reports.sh wrk 8082 &      # WRK results on port 8082
----

=== Viewing GitHub Pages Structure

To see exactly what will be deployed to GitHub Pages:

[source,bash]
----
# Run benchmarks
./mvnw verify -pl benchmarking/benchmark-core -Pbenchmark

# Navigate to GitHub Pages directory
cd benchmarking/benchmark-core/target/benchmark-results/gh-pages-ready

# Serve it
python3 -m http.server 8080
----

This directory structure is deployment-ready and can be committed to the `gh-pages` branch directly.
