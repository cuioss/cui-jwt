= OpenID Connect Discovery and Well-Known Configuration Endpoint
:toc: left
:toclevels: 3
:toc-title: Table of Contents
:sectnums:
:source-highlighter: highlight.js

xref:../Specification.adoc[Back to Main Specification]

== Overview
_See Requirements xref:../Requirements.adoc#OAUTH-SHERIFF-4[OAUTH-SHERIFF-4: Key Management] and xref:../Requirements.adoc#OAUTH-SHERIFF-4.1[OAUTH-SHERIFF-4.1: JWKS Endpoint Support]_

An integral part of OpenID Connect (OIDC) is the discovery mechanism, which allows Relying Parties (RPs) to dynamically discover information about OpenID Providers (OPs). This process simplifies the configuration of RPs and enhances the interoperability of OIDC implementations.

The primary means of discovering OP information is through a well-known URI, specifically `/.well-known/openid-configuration`, appended to the OP's Issuer Identifier. This endpoint returns a JSON document containing metadata about the provider's configuration.

=== Document Navigation

* xref:../../README.adoc[README] - Project overview and introduction
* xref:../../oauth-sheriff-core/README.adoc[Usage Guide] - How to use the library with code examples
* xref:../Requirements.adoc[Requirements] - Functional and non-functional requirements
* xref:../Specification.adoc[Specification] - Technical specifications
* xref:technical-components.adoc[Technical Components] - Implementation details

== Implementation Status

=== Status: IMPLEMENTED

The well-known discovery functionality has been implemented in the following classes:

==== Core Components

* xref:../../oauth-sheriff-core/src/main/java/de/cuioss/sheriff/oauth/core/well_known/HttpWellKnownResolver.java[HttpWellKnownResolver] - HTTP-based implementation for fetching well-known configuration
* xref:../../oauth-sheriff-core/src/main/java/de/cuioss/sheriff/oauth/core/well_known/WellKnownConfig.java[WellKnownConfig] - Configuration data model for well-known metadata
* xref:../../oauth-sheriff-core/src/main/java/de/cuioss/sheriff/oauth/core/well_known/WellKnownConfigurationConverter.java[WellKnownConfigurationConverter] - Converts discovery documents to configuration objects

==== Integration Components

* xref:../../oauth-sheriff-core/src/main/java/de/cuioss/sheriff/oauth/core/jwks/http/HttpJwksLoader.java[HttpJwksLoader] - Integrates with well-known discovery for JWKS retrieval
* xref:../../oauth-sheriff-core/src/main/java/de/cuioss/sheriff/oauth/core/jwks/http/HttpJwksLoaderConfig.java[HttpJwksLoaderConfig] - Configuration supporting well-known URLs
* xref:../../oauth-sheriff-core/src/main/java/de/cuioss/sheriff/oauth/core/IssuerConfig.java[IssuerConfig] - Supports well-known discovery for issuer configuration

For implementation details, see the JavaDoc of the implementation classes listed above.

==== Test Coverage

The following tests verify the implementation:

* xref:../../oauth-sheriff-core/src/test/java/de/cuioss/sheriff/oauth/core/well_known/WellKnownConfigTest.java[WellKnownConfigTest]
* xref:../../oauth-sheriff-core/src/test/java/de/cuioss/sheriff/oauth/core/well_known/WellKnownResultMappingTest.java[WellKnownResultMappingTest]
* xref:../../oauth-sheriff-core/src/test/java/de/cuioss/sheriff/oauth/core/well_known/WellKnownResultConverterTest.java[WellKnownResultConverterTest]

==== Test Utilities

* xref:../../oauth-sheriff-core/src/test/java/de/cuioss/sheriff/oauth/core/test/dispatcher/WellKnownDispatcher.java[WellKnownDispatcher] - WireMock-based test utility for simulating OIDC providers

== Purpose of `/.well-known/openid-configuration`

The `/.well-known/openid-configuration` endpoint serves as a standardized way for OPs to publish their capabilities and endpoint locations. By fetching this JSON document, an RP can obtain the necessary information to interact with the OP, such as the URLs for authorization, token exchange, and user information retrieval.

This discovery mechanism is defined in the OpenID Connect Discovery 1.0 specification. For more detailed information, refer to the official <<OpenID Connect Discovery 1.0, OpenID Connect Discovery 1.0 specification>>.

== Key Metadata Fields

The JSON response from the `/.well-known/openid-configuration` endpoint contains several key metadata fields. The following are some of the most important ones:

`issuer`::
REQUIRED. URL using the `https` scheme with no query or fragment components that the OP asserts as its Issuer Identifier. This value MUST be identical to the issuer value returned by WebFinger if used, and also MUST be identical to the `iss` Claim value in ID Tokens issued from this Issuer.

`authorization_endpoint`::
REQUIRED. URL of the OP's OAuth 2.0 Authorization Endpoint. This URL MUST use the `https` scheme and MAY contain port, path, and query parameter components.

`token_endpoint`::
URL of the OP's OAuth 2.0 Token Endpoint. This is REQUIRED unless only the Implicit Flow is used. This URL MUST use the `https` scheme and MAY contain port, path, and query parameter components.

`userinfo_endpoint`::
RECOMMENDED. URL of the OP's UserInfo Endpoint. This URL MUST use the `https` scheme and MAY contain port, path, and query parameter components.

`jwks_uri`::
REQUIRED. URL of the OP's JSON Web Key Set (JWK Set) document, which MUST use the `https` scheme. This document contains the signing key(s) the RP uses to validate signatures from the OP.

`scopes_supported`::
RECOMMENDED. JSON array containing a list of the OAuth 2.0 `scope` values that this server supports. The server MUST support the `openid` scope value.

`response_types_supported`::
REQUIRED. JSON array containing a list of the OAuth 2.0 `response_type` values that this OP supports. Dynamic OPs MUST support `code`, `id_token`, and `id_token token`.

`grant_types_supported`::
OPTIONAL. JSON array containing a list of the OAuth 2.0 Grant Type values that this OP supports. Dynamic OPs MUST support `authorization_code` and `implicit`. If omitted, the default value is `["authorization_code", "implicit"]`.

`subject_types_supported`::
REQUIRED. JSON array containing a list of the Subject Identifier types that this OP supports. Valid types include `pairwise` and `public`.

`id_token_signing_alg_values_supported`::
REQUIRED. JSON array containing a list of the JWS signing algorithms (`alg` values) supported by the OP for the ID Token to encode the Claims in a JWT. The algorithm `RS256` MUST be included. The value `none` MAY be supported but MUST NOT be used unless the Response Type used returns no ID Token from the Authorization Endpoint.

== JSON Web Key Set (JWKS) URI and Signature Validation

The `jwks_uri` plays a crucial role in securing OIDC communication. It points to a JWK Set document, which is a JSON object containing an array of JWKs. Each JWK represents a cryptographic key, typically a public key.

Relying Parties use the `jwks_uri` to:

. Fetch the OP's public keys.
. Cache these keys for a reasonable duration.
. Use the appropriate public key to validate the signature of ID Tokens and, if applicable, UserInfo responses that are returned as JWTs.

This process ensures the authenticity and integrity of the information received from the OP.

== Issuer Validation

A critical security measure in OIDC discovery is the validation of the `issuer` value. When an RP retrieves the configuration document from the `/.well-known/openid-configuration` endpoint, it MUST verify that the `issuer` value within the JSON document exactly matches the Issuer URL that was used to construct the `.well-known` URI.

This validation step helps prevent man-in-the-middle and DNS-based attacks where an attacker might try to impersonate a legitimate OP by providing a malicious discovery document. The `issuer` value from the discovery document must also match the `iss` claim in the ID Tokens issued by that OP.

=== Implementation and Testing

The issuer validation is implemented in:

* **Core Implementation**: `HttpWellKnownResolver.java:172-176` - Validates issuer during discovery
* **Validation Logic**: `WellKnownParser.validateIssuer()` - Performs comprehensive URL validation
* **Token Validation**: `TokenValidator.validateAndExtractIssuer()` - Ensures JWT contains issuer claim

Test coverage includes:

* **Well-Known Tests**: `WellKnownParserTest` - Tests issuer validation scenarios:
** `shouldValidateMatchingIssuerSuccessfully()` - Valid issuer scenarios
** `shouldReturnErrorForMalformedIssuerUrl()` - Malformed issuer URLs
** `shouldReturnErrorForIssuerValidationFailures()` - Protocol, host, port, and path mismatches
* **Integration Tests**: `HttpWellKnownResolverTest` - Tests complete discovery flow with issuer validation
* **Compliance Tests**: `RFC7519JWTComplianceTest` - Validates RFC 7519 Section 4.1.1 issuer claim handling

== Implementation Details

=== Well-Known Discovery Process

The library implements the well-known discovery process through the following workflow:

. **Endpoint Mapping**: The `WellKnownEndpointMapper` constructs the well-known configuration URL from an issuer URL
. **Configuration Retrieval**: The `HttpWellKnownResolver` fetches the discovery document from the constructed URL
. **Document Parsing**: The `WellKnownParser` parses the JSON response and validates required fields
. **Issuer Validation**: The implementation verifies that the `issuer` field matches the expected issuer URL
. **JWKS Integration**: The `HttpJwksLoader` uses the discovered `jwks_uri` to fetch public keys

=== Usage Example

[source,java]
----
// Configure issuer with well-known discovery
IssuerConfig config = IssuerConfig.builder()
    .httpJwksLoaderConfig(HttpJwksLoaderConfig.builder()
        .wellKnownUrl("https://example.com/.well-known/openid-configuration")
        .build())
    .expectedAudience(Set.of("my-client-id"))
    .build();

// The issuer identifier is automatically extracted from the discovery document
Optional<String> issuer = config.getIssuerIdentifier();
----

=== Security Considerations

The implementation enforces several security measures:

* **HTTPS Requirement**: Only HTTPS URLs are accepted for well-known endpoints
* **Issuer Validation**: The `issuer` field from the discovery document is validated against expectations
* **Timeout Protection**: Configurable timeouts prevent hanging on slow or unresponsive endpoints
* **Cache Management**: Discovery documents are cached with appropriate expiration to balance performance and freshness

== References

[[OpenID Connect Discovery 1.0]]
- [[[OpenID Connect Discovery 1.0, OpenID Connect Discovery 1.0 specification]]] https://openid.net/specs/openid-connect-discovery-1_0.html