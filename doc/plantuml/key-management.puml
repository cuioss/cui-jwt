@startuml
!include plantuml.skin

participant "IssuerConfig" as IssuerConfig
participant "HttpJwksLoader" as HttpLoader
participant "JWKS Endpoint" as Endpoint
database "Current Keys\n<<in-memory>>" as CurrentKeys
database "Retired Keys\n<<grace period>>" as RetiredKeys

== Initialization ==

IssuerConfig -> HttpLoader : "init()"
activate HttpLoader
HttpLoader -> Endpoint : "fetch JWKS"
Endpoint --> HttpLoader : "public keys"
HttpLoader -> CurrentKeys : "store keys"
deactivate HttpLoader

== Key Retrieval ==

IssuerConfig -> HttpLoader : "getKeyInfo(kid)"
HttpLoader -> CurrentKeys : "lookup key"
alt Key found in current
    CurrentKeys --> HttpLoader : "KeyInfo"
else Key not found, check retired
    HttpLoader -> RetiredKeys : "lookup in grace period"
    RetiredKeys --> HttpLoader : "KeyInfo (if valid)"
end
HttpLoader --> IssuerConfig : "Optional<KeyInfo>"

== Automatic Key Rotation ==

HttpLoader -> HttpLoader : "periodic refresh"
activate HttpLoader
HttpLoader -> Endpoint : "fetch JWKS"
Endpoint --> HttpLoader : "new keys"

alt Keys changed
    HttpLoader -> RetiredKeys : "move old keys to retired"
    HttpLoader -> CurrentKeys : "update with new keys"
    HttpLoader -> RetiredKeys : "cleanup expired keys"
else Keys unchanged
    note right: No rotation needed
end
deactivate HttpLoader

note right of RetiredKeys
  Grace Period (Issue #110):
  Tokens signed with old keys remain
  valid during grace period after rotation
end note

@enduml
